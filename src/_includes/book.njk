---
layout: base.njk
---

<article>
  <h1 class="book-title">{{ title }}</h1>

  {% if img_url %}
  <div class="book-cover">
    <img src="{{ img_url }}" alt="Cover of {{ title }}" />
  </div>
  {% endif %}
  <div class="book-header">
    <p><strong>Author:</strong> {{ author }}</p>

    {% if tags %}
    <p><strong>Tags:</strong> {{ tags | join(', ') }}</p>
    {% endif %} {% if date_read %}
    <p>
      <strong>Timeline:</strong> between {{ date_started | readableDate }} and
      {{ date_read | readableDate }}
    </p>
    {% else %}
    <p>
      <strong>Progress:</strong> {{ pct_progress }}% as of {{ latest_progress |
      readableDate }}
    </p>
    {% endif %}
  </div>
  <div class="book-body">
    {% block content %} {{ content | safe }} {% endblock %}
  </div>
  <div class="spoiler_btn"></div>
  {% if comments %}

  <section id="comments">
    <h2>Comments</h2>
    <form id="comment-form">
      <input type="text" name="author" placeholder="Name (optional)" />
      <textarea
        name="message"
        required
        placeholder="Write a comment…"
      ></textarea>
      <button type="submit">Post</button>
    </form>
    <ul id="comment-list" aria-live="polite"></ul>
  </section>

  <script type="module">
    const API = "https://api.c2lem.com/api/comments"
    const slug = "{{ page.url }}" // unique per page

    function escapeHtml(s) {
      return String(s).replace(
        /[&<>"']/g,
        (m) =>
          ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m])
      )
    }

    async function loadComments() {
      const res = await fetch(`${API}?slug=${encodeURIComponent(slug)}`)
      const { items = [] } = await res.json()
      document.getElementById("comment-list").innerHTML = items
        .map(
          (c) => `
    <li>
      <strong>${escapeHtml(c.author || "Anonymous")}</strong>
      <small> — ${new Date(c.created_at).toLocaleString()}</small>
      <p>${escapeHtml(c.message)}</p>
    </li>
  `
        )
        .join("")
    }

    document
      .getElementById("comment-form")
      .addEventListener("submit", async (e) => {
        e.preventDefault()
        const fd = new FormData(e.currentTarget)
        const payload = {
          slug,
          author: fd.get("author"),
          message: fd.get("message"),
        }
        const res = await fetch(API, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        })
        if (res.ok) {
          e.currentTarget.reset()
          loadComments()
        } else {
          const { error } = await res.json().catch(() => ({}))
          alert(error || "Failed to post comment.")
        }
      })

    loadComments()
  </script>

 
  {% endif %} 
  {% if date_read %}
  <p style="margin-top: 2rem">
    <a href="/books/" class="back-link">← Back to Books</a>
  </p>
  {% endif %}
</article>
